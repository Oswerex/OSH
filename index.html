<!DOCTYPE html>
<html lang="fil">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Safety Training with Assessment</title>

<style>
    :root {
        --primary:#0b5fff;
        --danger:#cc0033;
        --success:#1a7f37;
        --muted:#666;
        --card-bg:#ffffffcc;
        --bg:#e9efff;
    }

    body {
        background: linear-gradient(135deg,#0b5fff33,#ffffff);
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        line-height: 1.5;
    }

    .container {
        max-width: 900px;
        margin: auto;
    }

    .card {
        background: var(--card-bg);
        backdrop-filter: blur(6px);
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 3px 12px rgba(0,0,0,0.12);
        margin-top: 20px;
    }

    .hidden { display:none; }

    .btn {
        padding: 10px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
    }
    .btn-primary { background: var(--primary); color:#fff; }
    .btn-muted { background:#e5e5e5; color:#333; }

    input[type="text"] {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 6px;
        width: 250px;
    }

    .video-container {
        position: relative;
        width: 100%;
        padding-top: 56.25%;
    }
    .video-container video {
        position: absolute;
        top:0; left:0;
        width:100%; height:100%;
        border-radius:10px;
    }

    .question { font-weight: 600; margin-bottom: 6px; }
    .question-block { margin-bottom: 18px; }

    h2, h3 { margin-top: 0; }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
<div class="container">

<h2>Safety Training Module</h2>

<div class="card video-card">
    <h3>Watch the Safety Orientation Video</h3>
    <div class="video-container">
        <video id="trainingVideo" controls>
            <source src="https://oxwcrrgwbblxfozvqbmm.supabase.co/storage/v1/object/public/training%20videos/safety%20video.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
    </div>
    <div style="margin-top:12px;">
        <label>
            <input type="checkbox" id="watchedChk" disabled> I confirm that I watched the video.
        </label>
    </div>
</div>

<div class="card">
    <button id="startBtn" class="btn btn-primary" disabled>Start Assessment</button>
    <button id="resetBtn" class="btn btn-muted hidden">Reset</button>
</div>

<!-- ASSESSMENT -->
<div id="assessment" class="card hidden">
    <h3>Assessment</h3>

    <div class="question-block">
        <label class="question">1. Ano ang maximum speed limit sa loob ng Meralco Operating Center?</label><br>
        <label><input type="radio" name="q1" value="20 kph"> 20 kph</label><br>
        <label><input type="radio" name="q1" value="30 kph"> 30 kph</label><br>
        <label><input type="radio" name="q1" value="40 kph"> 40 kph</label><br>
        <label><input type="radio" name="q1" value="50 kph"> 50 kph</label>
    </div>

    <div class="question-block">
        <label class="question">2. Meralco is a (________) facility.</label><br>
        <label><input type="radio" name="q2" value="Smoke-free"> Smoke-free</label><br>
        <label><input type="radio" name="q2" value="Pet-friendly"> Pet-friendly</label><br>
        <label><input type="radio" name="q2" value="Noise-free"> Noise-free</label>
    </div>

    <div class="question-block">
        <label class="question">3. Follow (______) when using a fire extinguisher.</label><br>
        <label><input type="radio" name="q3" value="P.A.S.S"> P.A.S.S</label><br>
        <label><input type="radio" name="q3" value="S.O.P"> S.O.P</label><br>
        <label><input type="radio" name="q3" value="T.A.B"> T.A.B</label>
    </div>

    <div class="question-block">
        <label class="question">4. (______) trash bins are designated for used facemasks and tissues.</label><br>
        <label><input type="radio" name="q4" value="Biohazard"> Biohazard</label><br>
        <label><input type="radio" name="q4" value="Recyclable"> Recyclable</label><br>
        <label><input type="radio" name="q4" value="Compost"> Compost</label>
    </div>

    <div class="question-block">
        <label class="question">5. Ilagay ang pangalan ng Trainee:</label><br>
        <input type="text" id="traineeName" placeholder="Juan Dela Cruz">
    </div>

    <button id="submitBtn" class="btn btn-primary">Submit</button>
    <button id="retakeBtn" class="btn btn-muted hidden">Retake Assessment</button>
</div>

<div id="result" class="card hidden"></div>

</div>

<script>
const watchedChk = document.getElementById('watchedChk');
const startBtn = document.getElementById('startBtn');
const assessment = document.getElementById('assessment');
const resetBtn = document.getElementById('resetBtn');
const submitBtn = document.getElementById('submitBtn');
const retakeBtn = document.getElementById('retakeBtn');
const resultDiv = document.getElementById('result');
const trainingVideo = document.getElementById('trainingVideo');

// --- MONITORING CONFIG ---
const APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyBql2dvKoJ0IuzXEXOAhsgABQy1_il_bFJrXPMB1EbMvqyOVvhLckFZaMRZAsx6TpZ/exec";
const SECRET = "V9x!7Qm#4sP@2kT8zL$1gR";

// --- ATTEMPT TRACKING ---
let attemptCount = 1;

// Enable checkbox only when video ends
trainingVideo.addEventListener('ended', () => {
    watchedChk.disabled = false;
});

// Enable Start Assessment only if checkbox is checked
watchedChk.addEventListener('change', () => {
    startBtn.disabled = !watchedChk.checked;
});

startBtn.addEventListener('click', () => {
    assessment.classList.remove('hidden');
    resetBtn.classList.remove('hidden');
    resultDiv.classList.add('hidden');
});

resetBtn.addEventListener('click', resetAll);
retakeBtn.addEventListener('click', () => {
    attemptCount++;
    resetAll();
});

function resetAll() {
    ["q1","q2","q3","q4"].forEach(q => {
        let checked = document.querySelector(`input[name="${q}"]:checked`);
        if (checked) checked.checked = false;
    });
    document.getElementById('traineeName').value = "";
    resultDiv.innerHTML = "";
    resultDiv.classList.add('hidden');
}

submitBtn.addEventListener('click', async () => {
    let score = 0;

    if (document.querySelector('input[name="q1"]:checked')?.value === "30 kph") score++;
    if (document.querySelector('input[name="q2"]:checked')?.value === "Smoke-free") score++;
    if (document.querySelector('input[name="q3"]:checked')?.value === "P.A.S.S") score++;
    if (document.querySelector('input[name="q4"]:checked')?.value === "Biohazard") score++;

    let name = document.getElementById('traineeName').value.trim();
    if (!name) return alert("Pakilagay ang pangalan.");

    let result = score === 4 ? "PASS" : "FAIL";

    // --- SEND MONITORING DATA ---
    try {
        await fetch(APP_SCRIPT_URL, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                token: SECRET,
                name: name,
                score: score,
                result: result,
                attempts: attemptCount
            })
        });
        console.log("Monitoring record sent.");
    } catch (err) {
        console.error("Monitoring failed:", err);
    }

    // --- SHOW RESULT & GENERATE CERTIFICATE ---
    resultDiv.classList.remove('hidden');
    if (result === "PASS") {
        resultDiv.innerHTML = "<h3 class='result-pass'>PASADO!</h3><p>Generating certificateâ€¦</p>";
        generateCertificate(name);
        retakeBtn.classList.add('hidden');
    } else {
        resultDiv.innerHTML = "<h3 class='result-fail'>You FAILED.</h3><p>Try again.</p>";
        retakeBtn.classList.remove('hidden');
    }
});

async function generateCertificate(name) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "pt", format: "a4" });
    doc.setFontSize(28);
    doc.text("Certificate of Completion", 300, 120, { align:"center" });
    doc.setFontSize(18);
    doc.text(`Awarded to: ${name}`, 300, 200, { align:"center" });
    doc.text("Successfully completed the Safety Training Assessment", 300, 240, { align:"center" });
    doc.save(`Certificate_${name}.pdf`);
}
</script>

</body>
</html>
